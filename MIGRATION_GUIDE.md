# HiNote 数据存储优化迁移指南

## 概述

HiNote 插件已完成数据存储结构的重大优化，从单一的 `data.json` 文件存储迁移到分离式存储架构。这次优化将显著提升插件性能，特别是在处理大量高亮和闪卡数据时。

## 迁移内容

### 原有存储结构
```
.obsidian/plugins/hi-note/
└── data.json  # 包含所有数据：设置、高亮、评论、闪卡
```

### 新存储结构
```
.obsidian/plugins/hi-note/
├── data.json                    # 仅包含插件设置
└── Vault/
    └── .hinote/
        ├── highlights/
        │   ├── why_write.md.json
        │   └── ...
        ├── flashcards/
        │   └── cards.json
        └── metadata/
            ├── file-mapping.json
            └── migration-status.json
```

## 自动迁移流程

插件会在启动时自动检测是否需要数据迁移：

1. **检测阶段**：检查 `data.json` 中是否存在 `comments` 或 `fsrs` 数据
2. **备份阶段**：自动备份原始数据到 `.hinote/backup/`
3. **迁移阶段**：
   - 创建 `.hinote` 目录结构
   - 按文件分离高亮和评论数据
   - 迁移闪卡数据到独立文件
   - 清理 `data.json`，只保留设置
4. **验证阶段**：验证迁移数据的完整性
5. **完成标记**：创建迁移完成标记

## 数据格式优化

### 高亮数据优化
- **移除冗余字段**：去除重复的 `filePath` 和 `id` 字段
- **时间戳简化**：`createdAt/updatedAt` → `created/updated`
- **可选字段优化**：只保存非默认值的字段

### 性能提升
- **按需加载**：只加载当前文件的高亮数据
- **并行处理**：不同文件的数据可以并行读写
- **缓存优化**：减少重复文件读取
- **文件大小**：单个数据文件减少 15-20%

## 迁移安全措施

### 数据安全
- **自动备份**：迁移前自动备份所有原始数据
- **渐进式迁移**：支持新旧格式并存
- **回滚机制**：提供紧急回滚功能
- **数据验证**：多层数据完整性检查

### 错误处理
- **迁移失败**：自动回退到旧存储方式
- **数据损坏**：从备份文件恢复
- **部分迁移**：支持增量迁移重试

## 用户操作指南

### 正常使用
插件会自动处理所有迁移工作，用户无需任何操作。

### 检查迁移状态
可以通过命令面板执行"检查数据迁移状态"命令来查看迁移详情。

### 手动干预（仅在必要时）
如果遇到迁移问题，可以：
1. 重启 Obsidian
2. 禁用并重新启用插件
3. 查看控制台日志获取详细错误信息

## 兼容性说明

### 向前兼容
- 新版本完全兼容旧数据格式
- 迁移过程中保持功能正常使用
- 支持从任意旧版本升级

### 向后兼容
- 迁移后的数据不兼容旧版本插件
- 建议在迁移前备份整个 vault
- 如需回退，可使用备份数据

## 故障排除

### 常见问题

**Q: 迁移后数据丢失怎么办？**
A: 检查 `.hinote/backup/` 目录中的备份文件，可以手动恢复。

**Q: 迁移失败怎么办？**
A: 插件会自动回退到旧存储方式，功能不受影响。可以重启后重试。

**Q: 如何确认迁移成功？**
A: 执行"检查数据迁移状态"命令，查看迁移状态和验证结果。

### 日志信息
迁移过程中的详细信息会输出到浏览器控制台：
- 迁移开始/完成通知
- 迁移统计信息
- 错误和警告信息

## 性能对比

### 迁移前后性能提升
- **插件启动时间**：减少 50%+
- **大文件加载**：减少 60%+
- **内存使用**：减少 30%+
- **并发性能**：显著提升

### 适用场景
特别适合以下用户：
- 拥有大量高亮和评论的用户
- 使用大量闪卡的用户
- 对性能敏感的用户
- 多设备同步用户

## 技术细节

### 文件命名策略
- 使用安全的文件名转换：`folder/My File.md` → `folder_my_file.md.json`
- 维护原始路径映射关系
- 支持特殊字符和长路径

### 数据结构版本
- 当前版本：`2.0`
- 支持版本检查和升级
- 向前兼容机制

### 错误恢复
- 自动检测数据损坏
- 多级备份策略
- 增量修复机制

## 开发者信息

### 新增 API
- `HiNoteDataManager`：统一数据管理接口
- `DataMigrationManager`：迁移管理器
- `DataValidator`：数据验证器

### 配置选项
迁移过程可通过以下方式自定义：
- 备份保留时间
- 迁移验证级别
- 错误处理策略

---

如有任何问题或建议，请通过 GitHub Issues 反馈。
